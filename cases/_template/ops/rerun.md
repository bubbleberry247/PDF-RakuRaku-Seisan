# Rerun Procedure（1ステップ単位）

## 1. 目的

失敗時に「二重登録」や「状態不整合」を起こさず、STEP_ID単位で安全に再実行する。

---

## 2. 再実行前チェック（必須）

### 2.1 チェックリスト

- [ ] 失敗STEPの「副作用」列を確認（rk10_steps.md）
- [ ] 成功条件（観測）を満たしていないことを確認
- [ ] 証跡（ログ/スクショ/出力）を確認し、原因分類（error_code）を確定
- [ ] 再実行可否（rk10_steps.md の「再実行」列）を確認

### 2.2 確認ポイント

| 確認項目 | 確認方法 | NG時の対応 |
|----------|----------|------------|
| 副作用 | rk10_steps.md 参照 | 副作用ありなら手動確認必須 |
| 成功条件 | 画面/ファイル確認 | 成功済みならスキップ |
| error_code | ログ確認 | 原因対処が先 |

---

## 3. 再実行ルール

### 3.1 基本ルール

| ルール | 説明 |
|--------|------|
| 成功STEPはスキップ可 | ただし証跡が残っていること |
| 副作用ありSTEPは要注意 | 重複実行の危険があるため、再実行条件を満たす場合のみ |
| 再実行後は再確認必須 | 同じ証跡（ログ/出力/画面状態）を確認する |

### 3.2 再実行可否の判断

```
[失敗発生]
    │
    ▼
[rk10_steps.md の「再実行」列を確認]
    │
    ├─ Yes → [副作用列を確認]
    │           │
    │           ├─ 副作用なし → 再実行OK
    │           │
    │           └─ 副作用あり → [重複リスク確認]
    │                             │
    │                             ├─ リスクなし → 再実行OK
    │                             │
    │                             └─ リスクあり → 手動介入
    │
    └─ No → [前STEPから再実行が必要]
```

---

## 4. 再実行手順

### 4.1 STEP_ID指定再実行

1. RK10を起動
2. シナリオを選択
3. 「詳細設定」または「ステップ指定実行」を開く
4. 開始STEP_ID を入力（例: S030）
5. 「実行」

### 4.2 全体再実行

1. 失敗原因を解消（手動介入、設定修正など）
2. RK10を起動
3. シナリオを選択
4. 「実行」

---

## 5. 副作用別の注意事項

### 5.1 データ登録系

| 副作用 | 再実行時の注意 | 対策 |
|--------|----------------|------|
| 二重登録 | 既存データを確認 | 重複チェックロジック追加 |
| 連番採番 | 採番済みか確認 | 採番前に存在チェック |
| 承認フロー開始 | 承認済みか確認 | ステータスチェック |

### 5.2 ファイル出力系

| 副作用 | 再実行時の注意 | 対策 |
|--------|----------------|------|
| 上書き | 既存ファイルのバックアップ | タイムスタンプ付きファイル名 |
| 追記 | 重複行の発生 | 冪等性の確保 |

### 5.3 メール送信系

| 副作用 | 再実行時の注意 | 対策 |
|--------|----------------|------|
| 二重送信 | 送信済みか確認 | 送信ログ確認 |

---

## 6. 再実行後の確認

### 6.1 チェックリスト

- [ ] 成功条件を満たしている
- [ ] 副作用による問題が発生していない
- [ ] 後続STEPに影響がない
- [ ] ログに異常がない

### 6.2 確認完了報告

再実行完了後、以下を記録:

```
■ 再実行情報
- 日時: YYYY-MM-DD HH:MM:SS
- 対象STEP_ID: S030
- 結果: 成功 / 失敗
- 確認者: {NAME}

■ 確認内容
- 成功条件確認: OK
- 副作用確認: 問題なし
- ログ確認: 異常なし
```
