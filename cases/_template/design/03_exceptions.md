# 例外設計

## 1. 例外分類

| error_code | 分類 | 説明 | 重大度 |
|------------|------|------|--------|
| AUTH_EXPIRED | 認証 | セッション切れ、ログイン失敗 | HIGH |
| ELEMENT_NOT_FOUND | 画面差分 | 要素が見つからない | HIGH |
| TIMEOUT | 待機 | タイムアウト発生 | MEDIUM |
| IO_FILE_LOCK | ファイルI/O | ファイルロック中 | MEDIUM |
| DATA_VALIDATION | データ | 入力データ不正 | MEDIUM |
| NETWORK_ERROR | ネットワーク | 接続エラー | HIGH |

---

## 2. 例外ハンドリング方針

### 2.1 基本方針（TPS原則）

| 原則 | 適用 |
|------|------|
| ポカヨケ | 異常データ・想定外状態を自動検知し、処理を止める |
| アンドン | 異常発生時に即座に担当者へ通知 |
| 自働化 | 異常時は自動停止、正常時のみ継続 |

### 2.2 リトライ方針

| error_code | リトライ | 最大回数 | 待機時間 |
|------------|----------|----------|----------|
| TIMEOUT | Yes | 3 | 5秒 |
| IO_FILE_LOCK | Yes | 3 | 10秒 |
| NETWORK_ERROR | Yes | 2 | 30秒 |
| AUTH_EXPIRED | No | - | - |
| ELEMENT_NOT_FOUND | No | - | - |

---

## 3. 例外別対応手順

### 3.1 AUTH_EXPIRED（認証エラー）

**発生条件**: セッション切れ、認証情報期限切れ

**対応手順**:
1. 処理を即時停止
2. エラー通知メール送信
3. 手動で再ログイン
4. STEP_IDを指定して再実行

**再実行可否**: Yes（手動介入後）

### 3.2 ELEMENT_NOT_FOUND（要素未検出）

**発生条件**: 画面変更、セレクタ陳腐化

**対応手順**:
1. 処理を即時停止
2. エラー通知メール送信
3. スクリーンショット確認
4. セレクタ修正後、再実行

**再実行可否**: No（修正が必要）

### 3.3 TIMEOUT（タイムアウト）

**発生条件**: ページ読み込み遅延、ネットワーク遅延

**対応手順**:
1. 自動リトライ（最大3回）
2. リトライ失敗時、停止
3. エラー通知メール送信
4. 原因調査後、再実行

**再実行可否**: Yes

---

## 4. 通知設定

### 4.1 通知トリガー

| イベント | 通知 | 優先度 |
|----------|------|--------|
| 処理完了 | Yes | LOW |
| エラー発生 | Yes | HIGH |
| リトライ超過 | Yes | HIGH |
| 警告（閾値超過） | Yes | MEDIUM |

### 4.2 通知内容

→ [notification_email.md](../ops/notification_email.md) を参照

---

## 5. 復旧手順

### 5.1 自動復旧

| error_code | 復旧方法 |
|------------|----------|
| TIMEOUT | 自動リトライ |
| IO_FILE_LOCK | 待機後リトライ |

### 5.2 手動復旧

| error_code | 復旧手順 |
|------------|----------|
| AUTH_EXPIRED | 再ログイン → 再実行 |
| ELEMENT_NOT_FOUND | セレクタ修正 → 再デプロイ → 再実行 |
