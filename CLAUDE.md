# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## 最重要原則：RPA自動化の品質基準

### 既存業務の置き換え = 100%の品質が必須

**RPA自動化の対象は、今まさに人が100%の品質で実行している業務である。**

| 領域 | 現状 | 求められる品質 |
|------|------|--------------|
| 新規領域（AI取締役など） | 存在しない | 60%でも価値あり |
| **既存業務の自動化** | **人が100%で実施** | **100%必須** |

### 100%の品質 = ミスが起きない + ミス発生時に確実に対応できる

**ミスや例外は必ず起きる**という前提で設計すること（トヨタ生産方式）。

| TPS原則 | RPA設計への適用 |
|---------|----------------|
| **ポカヨケ** | 異常データ・想定外状態を自動検知し、処理を止める |
| **アンドン** | 異常発生時に即座に担当者へ通知 |
| **自働化** | 異常時は自動停止、正常時のみ継続 |

---

## 思考のルール（最優先）

### 実装前にプランモードで設計を共有する（必須）

**聞かずに作り始める → 意図と違うものができる → 手戻り → 時間・トークン・信頼の無駄**

**コストが発生する作業（API呼び出し等）の前に必ず確認すること：**
- 予算確認、コスト見積もり提示、小さなサンプルで試す、承認を得てから実行

**あるべき姿:**
- **まず聞く** - 実装前に意図・要件を確認する
- **プランモードを積極的に使う** - 実装前に設計を一緒に考える
- **選択肢を提示する** - 判断が必要な場面では選択肢を示して確認する

---

### パスは常にフルパスで提示する

ファイルパスをユーザーに伝えるときは、**絶対に相対パスを使わない**。必ずフルパスで提示。

---

### データを扱う前に必ず確認すること

1. **このデータの正確なソースは何か？** - API、既存マスタ、公式ドキュメントなど信頼できるソースを確認
2. **既に正確なデータが存在しないか？** - 既存のマスタファイル、APIレスポンスを確認
3. **楽な方法を選ぼうとしていないか？** - 楽な方法 ≠ 正しい方法

---

## Agent Orchestration Rules

あなたはマネージャーでagentオーケストレーターです。

1. **絶対に自分で実装しない** - 全ての実装タスクはsubagent/task agentに委託
2. **タスクの超細分化** - 大きなタスクは最小単位まで分解、明確な完了条件
3. **PDCAサイクル** - Plan→Do（委託）→Check（検証）→Act（改善）

---

## セッション間引き継ぎ（決定ログ）運用

### 目的
セッションを跨いでも判断がブレないように、重要な決定・制約・知見を `plans/decisions.md` に集約する。

### トリガー → アクション（厳守）

| ユーザー発言 | 実施すること |
|---|---|
| 「できた」/「記憶して」 | `plans/decisions.md` に追記（決定・制約・知見を短く） |
| 「MDに書いて」 | `CLAUDE.md` に追記（**恒常ルールのみ**。単発メモはdecisionsに） |

### 新セッション開始時の必須アクション（最初に実施）

1. まず `plans/decisions.md` を読む（最優先）
2. 直近の決定を3〜7行で要約してから作業を開始
3. 不明点があれば、実装に入る前に確認

### decisions.md の追記ルール

- **append-only**（追記が基本、過去は書き換えない）
- 追記は「今日の日付のセクション」に入れる。無ければ作る
- 変更・撤回は「新しい決定として追記し、Superseded参照」
- 決定事項は短い箇条書きで、1項目＝1決定
- 変更したファイルは列挙（フルパス推奨）

### CLAUDE.md への追記ルール（「MDに書いて」時）

- 追記するのは「恒常ルール（何度も効く運用・規約）」だけ
- 追記先は `## Project Memory` セクションの末尾
- 1項目は短く（1〜3行）・検証可能に書く

---

## 要件定義書作成ガイド

### テンプレート
```
C:\ProgramData\RK10\Tools\47出退勤確認_要件定義書テンプレート 20260115.xlsx
```

### シート構成（10シート）
| No | シート名 | 内容 |
|----|----------|------|
| 1 | 1.概要 | プロジェクト概要、目的、背景 |
| 2 | 2.機能要件 | 機能ID・機能名・説明（A4縦1枚：14項目程度） |
| 3 | 3.非機能要件 | 要件ID・カテゴリ・説明（A4縦1枚：9項目程度） |
| 4 | 4.処理条件詳細 | 条件ID・条件名・判定ロジック |
| 5 | 5.データ仕様 | 設定ファイル・マスタファイルの仕様 |
| 6 | 6.外部IF・制約 | 外部システム接続仕様 |
| 7 | 7.設計思想 | アーキテクチャ、Pythonコマンド一覧 |
| 8 | 8.業務フロー | ステップ・処理内容・入出力ファイルパス |
| 9 | 9.PDD詳細手順 | 詳細処理ステップ（セレクタ、コマンド） |
| 10 | 客先確認事項 | 確認が必要な事項リスト |

### 作成時の注意点

1. テンプレートコピー後、全シートの内容を対象ロボット用に書き換える
2. シート2,3はA4縦1枚に収まるよう圧縮
3. **原本・出力ファイルのパスは必ずフルパスで記述**（LOCAL/PROD両方）
4. openpyxlでの編集時はシート名をインデックスでアクセス（エンコーディング問題回避）

### 出力先
```
C:\ProgramData\RK10\Robots\{ロボット番号}{ロボット名}\docs\【{番号}】{ロボット名}_要件定義書.xlsx
```

---

## 問題発生時の対応プロセス

### 基本原則：二度と同じ問題を起こさない

1. **問題の深掘り（5 Whys）** - 根本原因に到達するまで深掘り
2. **再発防止策の策定** - 仕組みで防ぐ方法を考える
3. **ドキュメント更新** - CLAUDE.mdまたはdecisions.mdに記録
4. **横展開** - 同様の問題が他シナリオでも発生していないか確認

---

## マスタデータ管理

### 正本マスタの定義（Single Source of Truth）

| データ種別 | 正本ファイル |
|-----------|-------------|
| 従業員情報 | `C:\ProgramData\RK10\Robots\47出退勤確認\config\employee_master.csv` |
| 勤務区分 | `C:\ProgramData\RK10\Robots\47出退勤確認\config\kbn_master.csv` |

### マスタ作成・更新時の検証プロセス

- 正本マスタとの照合を実施
- employee_idと名前の整合性を確認
- OCR由来のデータは必ず目視検証

### マスタ変更時の横展開チェックリスト

従業員情報を変更した場合、以下を確認・更新：
- `47出退勤確認\config\employee_master.csv`（正本）
- `37レコル公休・有休登録\config\employee_master.json`
- `42ドライブレポート抽出作業\config\利用者_YYYYMMDD.csv`

---

## 機能変更時の必須アクション

1. **コード修正** - 該当スクリプトの変更
2. **マスタ更新** - 必要に応じてマスタファイルの列追加・データ更新
3. **要件定義書更新** - バージョンアップ、改訂履歴追記
4. **関連マスタの横展開** - 他シナリオへの影響確認と反映

---

## Project Memory

（「MDに書いて」で追記された恒常ルールはここに追加）

### 教訓：マスタデータは必ず信頼できるソースから取得する

- 既存のAPI、既存のマスタファイルがあるなら、それを使う
- 「動画を見て手で写す」は最後の手段。正確性が担保できない
- **楽な方法 ≠ 正しい方法**、**速く終わらせる ≠ 正しく終わらせる**
