# 44PDF一般経費楽楽精算申請 - 開発引継ぎ書

**作成日**: 2026-01-12
**作成者**: Claude Code

---

## 1. プロジェクト概要

### 目的
FAXで受信した請求書/領収書PDFを自動でOCR処理し、楽楽精算に登録するシナリオ

### フォルダパス
| 環境 | パス |
|------|------|
| PROD | `\\192.168.1.251\TIC-mainSV\【個人使用フォルダ】\管理部\・瀬戸\スキャン・FAX\` |
| LOCAL | `C:\ProgramData\RK10\Robots\44PDF一般経費楽楽精算申請\data\MOCK_FAX\` |

---

## 2. 今回のセッションで完了した作業

### 2.1 OCR抽出パターンの改善

**改善前 → 改善後の成功率**:
| 項目 | 改善前 | 改善後 |
|------|--------|--------|
| 成功率 | 75% | **100%** |
| 取引先抽出 | 57% | **80%** |
| 日付抽出 | 60% | **70%** |
| 金額抽出 | 60% | **77%** |
| 登録番号抽出 | 57% | **61%** |

### 2.2 主な改善内容

1. **PDF回転補正機能**（`fix_rotation`メソッド）
   - 横長PDFの自動検出・90度回転
   - 画像のアスペクト比チェック

2. **金額パターン追加**
   - 高速道路料金（`¥200-`形式）
   - 駐車料金（`駐車料金（一般）`）
   - OCR誤認識補正（`¥1 1 a` → `¥110`）

3. **取引先パターン追加**
   - 高速道路会社（愛知道路コンセッション、中日本高速道路）
   - 駐車場（名鉄協商パーキング）
   - 自治体（刈谷市）
   - スーパー（バロー）

4. **ファイル名からの情報補完**（`extract_from_filename`メソッド）
   - OCR失敗時のフォールバック
   - 日付・取引先・金額をファイル名から抽出

---

## 3. 修正したファイル

### 3.1 pdf_ocr.py（メインOCR処理モジュール）

**パス**: `C:\ProgramData\RK10\Robots\44PDF一般経費楽楽精算申請\tools\pdf_ocr.py`

**追加したメソッド**:
- `fix_rotation()` - PDF回転補正
- `extract_from_filename()` - ファイル名から情報抽出

**改善したメソッド**:
- `parse_invoice_data()` - 金額・日付・取引先パターン強化
- `run_ocr()` - 回転補正の統合
- `process_pdf()` - ファイル名フォールバック追加

---

## 4. テスト結果

### 4.1 サンプルPDF（33ファイル）の処理結果

OCR済みファイル: `C:\ProgramData\RK10\Tools\OCR-JA\output\`

| ファイル名 | 取引先 | 日付 | 金額 | 登録番号 |
|-----------|--------|------|------|----------|
| (株)ニトリ.pdf | ニトリ | - | - | - |
| 0109セリア(百均)買物.pdf | Seria | 20260108 | 110 | T4200001013662 |
| 愛知道路コンセッション | ARC | - | 200 | - |
| ... | ... | ... | ... | ... |

**全31ファイル成功（100%）**

---

## 5. 残りの実装タスク

### 5.1 未実装機能

1. **楽楽精算アップロード**（`rakuraku_upload.py`）
   - Playwrightでの楽楽精算操作
   - 参考: `51&52ソフトバンク部門集計楽楽精算申請\rakuraku_receipt.py`

2. **メイン処理スクリプト**（`main_44.py`）
   - FAXフォルダからPDF取得
   - OCR処理 → 楽楽精算アップロードの連携

3. **RKSシナリオファイル**
   - RK10シナリオの作成

### 5.2 楽楽精算の入力フォーム情報

URL: `https://rsatonality.rakurakuseisan.jp/sapEbookFile/initializeView`

| フィールド | 備考 |
|-----------|------|
| 添付ファイル | PDFアップロード |
| 書類区分 | 領収書/請求書 ラジオボタン |
| 保存形式 | 電子取引/スキャナ保存/未指定 |
| 取引日 | 自動入力（OCR） |
| 受領日 | 自動入力 |
| 事業者登録番号 | T+13桁 |
| 取引先名 | 自動入力（OCR） |
| 金額 | 自動入力（OCR） |

---

## 6. 既知の課題

### 6.1 OCR品質依存の問題

以下のケースはOCR品質が悪く、ファイル名からの補完で対応:
- 手書き領収書（領収証2025.12.26.pdf）
- 金券チャージレシート（BP-60C31_*.pdf）
- 回転したレシート（ニトリ）

### 6.2 抽出精度の限界

- 取引先名のOCR誤認識（例: 「三井不勧産」→「三井不動産」）
- 一部の日付未抽出（高速道路領収書など）

---

## 7. 開発環境情報

### 7.1 依存パッケージ

```
PyMuPDF (fitz) - PDF処理
Node.js - OCR-JA実行
```

### 7.2 OCR-JAパス

`C:\ProgramData\RK10\Tools\OCR-JA\`

| フォルダ | 用途 |
|----------|------|
| input | OCR対象PDF置き場 |
| output | OCR済みPDF出力 |
| archive | 処理済みPDF保存 |
| error | OCR失敗PDF |

---

## 8. 次回セッションでの作業推奨

1. `rakuraku_upload.py`の実装開始
2. 楽楽精算のセレクタ調査（Playwright DevTools）
3. 既存シナリオ51&52からのコード流用
4. LOCAL環境でのE2Eテスト

---

## 9. 参照ファイル

- 計画書: `C:\Users\masam\.claude\plans\glimmering-greeting-yao.md`
- サンプルPDF: `C:\ProgramData\RK10\Robots\44PDF一般経費楽楽精算申請\docs\sample PDF\`
- 既存シナリオ: `C:\ProgramData\RK10\Robots\51&52ソフトバンク部門集計楽楽精算申請\`
