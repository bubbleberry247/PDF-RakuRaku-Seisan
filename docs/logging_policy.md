# Logging Policy（機微情報取り扱い）v0.1

**最終更新**: 2026-01-17
**ステータス**: ドラフト

---

## 1. 目的

ログ・エラー出力・サマリに機微情報を出さないことで、情報漏洩リスクを最小化する。

---

## 2. 禁止（ログに出さない）

以下の情報は**絶対にログ・エラー出力・サマリに出力しない**。

| カテゴリ | 例 |
|---------|-----|
| 取引先名（生） | 株式会社○○ |
| 事業者登録番号（生） | T1234567890123 |
| 金額（生） | 15,000円 |
| 請求書番号（生） | INV-2026-0001 |
| 個人名 | 山田太郎 |
| 住所 | 東京都○○区... |
| 電話番号 | 03-1234-5678 |
| メールアドレス | user@example.com |
| URLクエリパラメータ | ?token=xxx&user=yyy |
| 認証情報 | セッションID、Cookie |
| トークン/パスワード | API Key、Secret |
| クレジットカード情報 | カード番号、CVV |

---

## 3. 許容（ログに出して良い）

以下の情報は**ログに出力して良い**。

| カテゴリ | 例 | 備考 |
|---------|-----|------|
| 件数 | 入力:10, 成功:8, 手動:1, 失敗:1 | 集計のみ |
| エラー分類 | 例外種別: OCR_TIMEOUT | 種別名のみ |
| 処理時間 | 1234ms | ミリ秒 |
| case_id | hash:abc123def456 | 匿名ID（ハッシュ） |
| ファイル名（匿名化後） | case_001.pdf | 元ファイル名は出さない |
| 処理ステップ | preprocess, ocr, upload | ステップ名のみ |
| 信頼度スコア | 0.85 | 数値のみ |
| タイムスタンプ | 2026-01-17T10:30:00+09:00 | ISO 8601形式 |

---

## 4. マスキング規約

やむを得ずログに含める場合の**マスキングルール**。

| 項目 | マスキング例 | 説明 |
|------|-------------|------|
| vendor_name | `***` | 完全マスク |
| reg_no | `****-****-**12` | 末尾2桁のみ |
| amount | `range: 10k-50k` | レンジ表記 |
| invoice_no | `hash:<sha256先頭8文字>` | ハッシュ化 |
| phone | `***-****-1234` | 末尾4桁のみ |
| email | `u***@***.com` | 部分マスク |

### マスキング実装例（Python）

```python
import hashlib

def mask_vendor_name(name: str) -> str:
    return "***"

def mask_reg_no(reg_no: str) -> str:
    if len(reg_no) >= 4:
        return "****-****-**" + reg_no[-2:]
    return "****"

def mask_amount(amount: int) -> str:
    if amount < 1000:
        return "range: <1k"
    elif amount < 10000:
        return "range: 1k-10k"
    elif amount < 50000:
        return "range: 10k-50k"
    elif amount < 100000:
        return "range: 50k-100k"
    else:
        return "range: >100k"

def hash_invoice_no(invoice_no: str) -> str:
    h = hashlib.sha256(invoice_no.encode()).hexdigest()[:8]
    return f"hash:{h}"
```

---

## 5. 共有ルール

### 5.1 外部共有

| ルール | 説明 |
|--------|------|
| ログ本文の共有禁止 | 外部にログ本文を共有しない |
| 集計のみ共有可 | 件数・エラー率・処理時間の集計は共有可 |
| サマリ形式 | グラフ・表など匿名化された形式で共有 |

### 5.2 障害解析時

| ルール | 説明 |
|--------|------|
| 最小期間 | 問題解決に必要な最小期間のみ閲覧 |
| 最小権限 | 必要な権限を持つ担当者のみ閲覧 |
| 閲覧記録 | 誰がいつ閲覧したか記録（TBD） |
| 解析後削除 | 一時的にコピーしたログは解析後削除 |

---

## 6. ログレベル定義

| レベル | 用途 | 機微情報 |
|--------|------|---------|
| DEBUG | 開発時詳細 | **含めない** |
| INFO | 正常系処理 | **含めない** |
| WARNING | 注意事項 | **含めない** |
| ERROR | エラー発生 | **含めない** |
| CRITICAL | 重大障害 | **含めない** |

**全レベルで機微情報は出力禁止**。

---

## 7. ログ出力フォーマット

### 7.1 推奨フォーマット

```
[TIMESTAMP] [LEVEL] [case_id] [step] message (metrics)
```

### 7.2 例

```
[2026-01-17T10:30:00+09:00] [INFO] [hash:abc123] [ocr] OCR completed (confidence=0.85, time=1234ms)
[2026-01-17T10:30:01+09:00] [WARNING] [hash:abc123] [ocr] Low confidence detected (confidence=0.35)
[2026-01-17T10:30:02+09:00] [ERROR] [hash:abc123] [upload] Upload failed (error_type=TIMEOUT)
```

### 7.3 NGフォーマット例

```
# NG: 取引先名が生で出ている
[ERROR] Upload failed for vendor: 株式会社○○

# NG: 金額が生で出ている
[INFO] Amount extracted: 15000円

# NG: 事業者登録番号が生で出ている
[DEBUG] Registration number: T1234567890123
```

---

## 8. ログ保管

| 項目 | 設定 |
|------|------|
| 保管場所 | `logs/` |
| ローテーション | 日次 |
| 保管期間 | TBD（例: 30日） |
| アーカイブ | TBD（圧縮して保管） |
| 削除 | 保管期間後に自動削除 |

---

## 9. チェックリスト（コードレビュー時）

- [ ] `print()` や `logger.xxx()` に機微情報が含まれていないか
- [ ] 例外メッセージに機微情報が含まれていないか
- [ ] デバッグ用コードが残っていないか
- [ ] マスキング関数を使用しているか
- [ ] case_idは匿名化されているか

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-01-17 | v0.1 | 初版作成 |
