# Regression Criteria（回帰試験基準）v0.1

**最終更新**: 2026-01-17
**ステータス**: ドラフト

---

## 1. 目的

コード変更後に品質が維持されていることを確認するための基準を定義する。

---

## 2. 回帰セット

### 2.1 テストPDF構成

| カテゴリ | 件数 | 説明 |
|---------|------|------|
| きれい（高品質） | TBD | 明瞭な印刷、傾きなし |
| かすれ（低品質） | TBD | インク薄い、解像度低 |
| 傾き | TBD | 5〜30度の傾き |
| 極端傾き | TBD | 30度以上の傾き |
| 回転（90/180/270） | TBD | 横向き、逆さまなど |
| 複数ページ | TBD | 2ページ以上 |
| 手書き混在 | TBD | 手書き金額/メモ含む |
| 特殊レイアウト | TBD | 非標準フォーマット |

**合計**: TBD件（匿名化済み）

### 2.2 保管場所

```
C:\ProgramData\Generative AI\Github\PDF-RakuRaku-Seisan\data\regression_test\
```
※機密情報を含まない匿名化済みPDFのみ保管

---

## 3. 計測指標

| 指標 | 説明 | 計算式 |
|------|------|--------|
| 成功率 | 自動登録完了の割合 | 成功件数 / 入力件数 |
| 例外率 | 失敗+手動の割合 | (失敗+手動) / 入力件数 |
| manual_queue率 | 手動キュー退避の割合 | 手動件数 / 入力件数 |
| 重要項目誤り | 金額/日付/登録番号の誤り | 誤り件数 |
| 二重登録 | 同一案件の重複登録 | 発生件数 |
| 処理時間（平均） | 1件あたりの平均処理時間 | 合計時間 / 件数 |
| 処理時間（P95） | 95パーセンタイル | 上位5%を除いた最大値 |

---

## 4. 合格条件（暫定）

### 4.1 品質指標

| 指標 | 閾値 | 現状（参考） |
|------|------|-------------|
| 成功率 | >= 80% | 86.5% |
| 例外率 | <= 20% | 13.5% |
| manual_queue率 | <= 15% | TBD |
| 重要項目誤り | <= 2件 | TBD |
| **二重登録** | **= 0件** | **必須** |

### 4.2 性能指標

| 指標 | 閾値 | 現状（参考） |
|------|------|-------------|
| 処理時間（平均） | <= 60秒/件 | 約30秒/件 |
| 処理時間（P95） | <= 120秒/件 | TBD |

### 4.3 必須条件（Blocker）

以下を満たさない場合は**リリース不可**。

- [ ] 二重登録 = 0件
- [ ] 成功率が前回より10%以上低下していない
- [ ] システムエラー（例外終了）= 0件

---

## 5. 回帰テスト実行タイミング

### 5.1 必須（変更時に必ず実行）

| 変更種別 | 例 |
|---------|-----|
| OCRロジック変更 | 抽出パターン追加、閾値変更 |
| PDF前処理変更 | 回転検出、傾き補正 |
| 楽楽精算操作変更 | セレクタ修正、フロー変更 |
| config変更 | ENV/パス/項目の変更 |

### 5.2 推奨（定期実行）

| 頻度 | 目的 |
|------|------|
| 週次 | 外部依存（API等）の変化検知 |
| リリース前 | 品質ゲート |

---

## 6. 実行手順

### 6.1 準備

```bash
cd "C:\ProgramData\Generative AI\Github\PDF-RakuRaku-Seisan\tools"

# 回帰テスト用データを配置（TBD: 自動化）
# data/regression_test/ にテストPDFを配置
```

### 6.2 実行

```bash
# dry-runで回帰テスト
python main_44_rk10.py --regression --dry-run

# 結果確認
type logs\regression_result.json
```

### 6.3 結果確認

```json
{
  "timestamp": "2026-01-17T10:00:00+09:00",
  "total": 74,
  "success": 64,
  "manual_queue": 8,
  "failed": 2,
  "success_rate": 0.865,
  "exception_rate": 0.135,
  "important_errors": 1,
  "duplicate_registrations": 0,
  "avg_time_ms": 30000,
  "p95_time_ms": 55000,
  "pass": true
}
```

---

## 7. 失敗時の対応

### 7.1 閾値未達

1. 失敗ケースの分析
2. 原因特定（パターン/閾値/ロジック）
3. 修正
4. 再テスト

### 7.2 性能劣化

1. ボトルネック特定（前処理/OCR/アップロード）
2. プロファイリング
3. 最適化
4. 再テスト

### 7.3 Blocker発生

1. **即座にリリース停止**
2. 原因調査
3. 修正
4. 全件再テスト

---

## 8. レポートフォーマット

### 8.1 サマリ

```markdown
## Regression Test Report - 2026-01-17

### Result: PASS / FAIL

### Metrics
| 指標 | 値 | 閾値 | 判定 |
|------|-----|------|------|
| 成功率 | 86.5% | >= 80% | ✅ |
| 例外率 | 13.5% | <= 20% | ✅ |
| 二重登録 | 0件 | = 0件 | ✅ |

### Failed Cases
（なければ「なし」）

### Notes
（特記事項）
```

---

## 9. 継続的改善

### 9.1 テストセット拡充

新しい失敗パターンを発見したら：
1. 匿名化してテストセットに追加
2. 期待結果を定義
3. 回帰テストに組み込み

### 9.2 閾値の見直し

- 成功率が安定して高い場合 → 閾値を引き上げ
- 新機能追加で一時的に低下 → 現実的な目標を再設定

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-01-17 | v0.1 | 初版作成 |
