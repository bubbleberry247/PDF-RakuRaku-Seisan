# Manual Queue SOP（手動キュー運用）v0.2

**最終更新**: 2026-01-17
**ステータス**: 確定（OM3向け）
**対象読者**: 顧客（運用担当者）

---

## 1. 目的

OCR/自動登録で確信が持てないケースを人手で補完し、**業務結果としての100%品質**を成立させる。

**重要**: OM3体制では、本SOPの実行責任は**顧客**にあります。

---

## 2. 対象

`work/manual_queue/` に入った案件（以下の理由で退避）:

| 退避理由 | 説明 | 対応者 |
|---------|------|--------|
| 低信頼度 | OCR信頼度スコアが閾値（0.40）未満 | 顧客（Reviewer） |
| 登録失敗 | 楽楽精算への登録でエラー | 顧客（Operator） |
| 例外停止 | 想定外のレイアウト/フォーマット | 顧客→開発者 |
| pause判定 | pauseモードで人が確認待ち | 顧客（Reviewer） |

---

## 3. 共通フロー

```
1) 受付（キュー投入）
    ↓
2) トリアージ（原因分類）【顧客】
    ├─ 低信頼度 → 照合・補完【顧客】
    ├─ 登録失敗 → 原因調査【顧客】
    │   └─ 原因不明 → 開発者へエスカレーション
    └─ 例外停止 → 開発者へエスカレーション
    ↓
3) 照合（OCR出力と元PDF比較）【顧客】
    ↓
4) 補完（必要項目を修正）【顧客】
    ※値の詳細は監査ログに記録しない
    ↓
5) 確定（登録）または 差戻し【顧客】
    ↓
6) 完了処理【顧客】
    ├─ processed/ へ移動
    └─ 監査ログ記録
```

---

## 4. 詳細手順（顧客向け）

### 4.1 受付確認

```bash
# manual_queue内の件数確認
dir /b "work\manual_queue\" | find /c /v ""

# 内容一覧
dir "work\manual_queue\"
```

### 4.2 トリアージ

1. **低信頼度**（confidence < 0.40）
   - OCR結果を目視確認
   - 元PDFと照合して補完
   - **顧客で完結可能**

2. **登録失敗**
   - エラーログ確認
   - 楽楽精算側の状態確認
   - 原因特定後に再試行
   - **原因不明の場合 → 開発者へ連絡**

3. **例外停止**
   - ログを収集して **開発者へ連絡**
   - 開発者がパターン追加等で対応

### 4.3 照合・補完

1. 元PDFを開く
2. OCR抽出結果と比較
3. 相違点を修正
4. 修正した項目を記録（項目名のみ、値は記録しない）

### 4.4 確定

```bash
# 個別ファイルの再処理（修正後）
python main_44_rk10.py --file "work\manual_queue\target.pdf"
```

### 4.5 完了処理

1. 正常完了 → `processed/` へ移動
2. 監査ログに記録

---

## 5. 監査ログ（最小）

### 5.1 記録項目

| 項目 | 説明 | 記録 |
|------|------|------|
| case_id | 匿名ID（ハッシュ） | ○ |
| timestamp | 処理日時 | ○ |
| operator | 実施者ID | ○ |
| action | 実施内容（照合/補完/確定/差戻し） | ○ |
| modified_fields | 変更した項目名 | ○ |
| result | 結果（完了/差戻し/保留） | ○ |
| reason_category | 理由分類 | ○ |
| **値の詳細** | 金額/取引先名など | **×（記録しない）** |

### 5.2 フォーマット例

```json
{
  "case_id": "hash:abc123",
  "timestamp": "2026-01-17T10:30:00+09:00",
  "operator": "user001",
  "action": "補完",
  "modified_fields": ["amount", "vendor_name"],
  "result": "完了",
  "reason_category": "低信頼度"
}
```

---

## 6. SLA（顧客が決定）

`docs/operating_model.md` を参照。

| 指標 | 推奨値 | 備考 |
|------|--------|------|
| 初動（確認開始） | 当日中 | 顧客が決定 |
| 完了（登録確定） | 翌営業日 | 顧客が決定 |
| 滞留アラート閾値 | 5件 | 顧客が決定 |

---

## 7. エスカレーション

### 7.1 顧客内エスカレーション

| 状況 | 対応先 | アクション |
|------|--------|-----------|
| 滞留増加 | Owner（顧客内） | 優先度調整 |
| SLA超過 | Owner（顧客内） | 対策協議 |

### 7.2 開発者へのエスカレーション

| 状況 | 連絡先 | 必要情報 |
|------|--------|---------|
| 原因不明のエラー | 開発者（Maintainer） | エラーログ、対象PDF（可能なら） |
| パターン追加が必要 | 開発者（Maintainer） | 対象PDF、期待結果 |
| システム停止 | 開発者（Maintainer） | 発生日時、エラーメッセージ |

**連絡時の注意**:
- 機微情報（金額、取引先名など）は原則共有しない
- ログ共有時は`logging_policy.md`に従う
- 緊急度を明示（業務停止/継続可能）

---

## 8. OM3体制における責任分界

### 8.1 顧客の責任範囲

| 作業 | 顧客責任 |
|------|---------|
| 日次のmanual_queue確認 | ○ |
| 照合・補完作業 | ○ |
| 楽楽精算への登録確定 | ○ |
| 監査ログの保管 | ○ |
| SLA管理 | ○ |

### 8.2 開発者の責任範囲

| 作業 | 開発者責任 |
|------|-----------|
| パターン追加（新しいPDFフォーマット対応） | ○ |
| バグ修正 | ○ |
| 性能改善 | ○ |
| 問い合わせ対応 | ○ |

### 8.3 権限分界

| 項目 | 顧客 | 開発者 |
|------|------|--------|
| PROD環境アクセス | ○ | **×（原則なし）** |
| 楽楽精算ログイン | ○ | **×** |
| manual_queue処理 | ○ | × |
| コード修正 | × | ○ |
| 障害調査（依頼ベース） | △ | ○ |

---

## 9. よくある質問（FAQ）

### Q1: 開発者に何を伝えればよいですか？

**最低限の情報**:
- 発生日時
- エラーメッセージ（画面キャプチャ可）
- 対象ファイル名（ファイル内容は原則不要）
- 緊急度（業務停止/継続可能）

### Q2: 機密情報を含むPDFを開発者に共有してよいですか？

**原則**: 共有しない
**例外**: 障害解析に必要な場合、顧客の判断で共有（マスキング推奨）

### Q3: 開発者への連絡手段は？

`docs/operating_model.md` の「コミュニケーション」セクションを参照。

---

## Appendix A: OM1（自社運用）特記事項

※OM3確定のため、このセクションは参考情報です。

---

## Appendix B: OM3（顧客運用）チェックリスト

### 日次チェック

- [ ] manual_queueの件数確認
- [ ] 滞留アラート閾値を超えていないか
- [ ] 前日の処理完了確認

### 週次チェック

- [ ] 例外傾向の確認（同じパターンの繰り返しがないか）
- [ ] パターン追加要望の有無

### 月次チェック

- [ ] 処理件数の推移確認
- [ ] 開発者との定例（改善要望の共有）

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-01-17 | v0.1 | 初版作成（OM1想定） |
| 2026-01-17 | v0.2 | OM3に確定、顧客向けに全面改訂 |
