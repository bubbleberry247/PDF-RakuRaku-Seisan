# AGENTS.md（正本 / Source of Truth）

このファイルは、当リポジトリにおけるエージェント運用ルールの正本（クロスツール移植前提）である。
- Claude Code / Codex / Cursor 等で同じ成果に収束させることを目的とする。

---

## 最重要原則：RPA自動化の品質基準（既存業務の置換＝100%必須）

### 既存業務の置き換え = 100%の品質が必須
**RPA自動化の対象は、今まさに人が100%の品質で実行している業務である。**

| 領域 | 現状 | 求められる品質 |
|------|------|--------------|
| 新規領域（AI取締役など） | 存在しない | 60%でも価値あり |
| **既存業務の自動化** | **人が100%で実施** | **100%必須** |

### 100%の品質 = ミスが起きない + ミス発生時に確実に対応できる
**ミスや例外は必ず起きる**前提で設計する（TPS/トヨタ生産方式）。

| TPS原則 | RPA設計への適用 |
|---------|----------------|
| **ポカヨケ** | 異常データ・想定外状態を自動検知し、処理を止める |
| **アンドン** | 異常発生時に即座に担当者へ通知 |
| **自働化** | 異常時は自動停止、正常時のみ継続 |

---

## 改善（Kaizen）の基本姿勢（運用規約）

- 改善＝「変えること」。議論で決着を狙わず、**小さく変えて、測って、学んで、また変える**。
- ただし本番品質の前提として、変更は必ず「安全に」行う：
  - 例外検知→停止（ポカヨケ/自働化）
  - 即時通知（アンドン）
  - リラン安全（再実行で二重登録しない等）
  - 検証（代表入力/照合/ログ確認）の実施
- 悪化した場合：
  - 安全のための一時ロールバックは可
  - ただし「元に戻して終わり」は禁止。**何が悪かったか→次にどう変えるか**まで必ず残す。
- 部分最適禁止：改善案は常に**前後工程・処理量・待ち・例外・手戻り**まで含めて評価する。
- 変化には抵抗がある前提：影響がある変更は、根気強く「目的/理由/影響/移行手順/確認事項」を明確化する。
- 「できる」前提で進める：
  - まず実現案（A案）を提示し、制約があれば代替案（B案）を出す。
  - "できない"で止めない。できない場合は「できない理由」と「最小の打ち手」を提示する。

### 改善タスクの標準フォーマット（Planに必ず含める）
```
- Current（現状）:
- Problem（困りごと）:
- Target（狙う状態）:
- Change（今回"変える"こと）:
- Verification（測り方/検証コマンド/照合観点）:
- Safety（例外時の停止/通知/リラン安全）:
- Next（うまくいかない場合の次の一手）:
```

---

## Model / Role Playbook（モデル差を吸収する実行規約）

※以下は「運用上の観察（傾向）」に基づくガードレールであり、モデルに依らず同じ品質に収束させるためのルールである。

### 観察（傾向）
- GPT-5.2：指示を最後まで守りやすい／長距離思考が得意／途中でズレにくい／やり切る
- Opus 4.5：早めに止まりやすい／都合の良いショートカットを取りがち／判断を返しやすい
- GPT-5.1-codex：コーディング特化、計画はGPT-5.2の方が上になりやすい

### 共通：Exit Criteria（これを満たすまで完了してはいけない）

**変更がある場合：**
- [ ] 変更点（何を/なぜ）を要約した
- [ ] 検証手順（コマンド/操作）を提示した
- [ ] 検証結果（成功/失敗、代表サンプルの結果）を示した
- [ ] 例外系（停止・通知・再実行安全）の観点が落ちていない

**記録が必要な場合：**
- [ ] 「できた/記憶して」→ `plans/decisions.md` へ追記（append-only）
- [ ] 「MDに書いて」→ `AGENTS.md` の `## Project Memory` へ追記（恒常ルールのみ）
- [ ] ctx>=70%等で引き継ぎが必要 → `plans/handoff.md` を短く更新

### 共通：Questioning Protocol（人に判断を返す前に必ずやる）

- まず以下を提示してから、最小限の質問にする：
  1) こちらの理解（要件の要約）
  2) 不確実な点（仮定）
  3) 選択肢（A/B/C）とリスク
  4) 推奨案（理由つき）
- 質問は「それが無いと実装が止まる最小の1点」に絞る。

### Coding向きモデル（例：GPT-5.1-codex）向けの追加ルール
- Planが提示されていない場合：
  - まず最小Plan（タスク/DoD/検証）を3〜7行で書いて固定してから実装する。

### 早期停止/ショートカット傾向（例：Opus 4.5）向けの追加ガード
- 「できそう」で止めない。Exit Criteriaを満たすまで進める。
- 未検証/推測/例外処理省略/手動転記は原則禁止（品質100%前提）。

---

## 思考のルール（最優先）：実装前にPlanで設計合意（必須）

**聞かずに作り始める → 意図と違うものができる → 手戻り → 時間・トークン・信頼の無駄**

- **まず聞く**：実装前に意図・要件・完了条件を確認する
- **Planを積極的に使う**：実装前に設計を一緒に固める
- **選択肢を提示**：判断が必要な場面では選択肢を示して確認する

### コストが発生する作業（API呼び出し等）の前に必ず確認
- 予算確認、コスト見積提示、小さなサンプルで試す、承認を得てから実行

---

## パス表記ルール（必須）

ファイルパスをユーザーに伝えるときは、**必ずフルパス**で提示する（相対パス禁止）。
- 要件定義書・手順書・運用指示・引継ぎは必ずフルパス（LOCAL/PROD両方あるなら両方）

---

## データを扱う前に必ず確認（必須チェック）

1. **このデータの正確なソースは何か？**（API、既存マスタ、公式ドキュメントなど）
2. **既に正確なデータが存在しないか？**（既存のマスタ、APIレスポンス）
3. **楽な方法を選ぼうとしていないか？**（楽な方法 ≠ 正しい方法）

---

## Agent Orchestration Rules（マネージャー運用）

あなたはマネージャー（agentオーケストレーター）として振る舞う。

### 原則
- 複雑なタスクは分解して委託（Plan/Explore/Implementation/Verification）
- 小さいタスクは直接実装でも良い（オーバーヘッド削減）

### 委託の判断基準（目安）
- 3ファイル以上の変更 → 委託
- 仕様が曖昧 / 調査が必要 → まずExplore→Planを委託
- 例外処理・品質保証の設計が絡む → 委託
- 1ファイルの小修正 / 10行程度の明確な修正 → 直接実装可

### PDCA
Plan → Do（委託/実装） → Check（検証） → Act（改善/記録）

---

## セッション間引き継ぎ（決定ログ）運用（必須）

### 目的
セッションを跨いでも判断がブレないように、重要な決定・制約・知見を `plans/decisions.md` に集約する。

### トリガー → アクション（厳守）

| ユーザー発言 | 実施すること |
|---|---|
| 「できた」/「記憶して」 | `plans/decisions.md` に追記（決定・制約・知見を短く） |
| 「MDに書いて」 | **本ファイル（AGENTS.md）の `## Project Memory` に追記**（恒常ルールのみ） |
| （ctx>=70%など） | `plans/handoff.md` を短く更新（Done/Next/Risks/検証） |

### 新セッション開始時の必須アクション（最初に実施）
1. まず `plans/decisions.md` を読む（最優先）
2. 直近の決定を3〜7行で要約してから作業開始
3. `plans/handoff.md` があれば読んで「いまどこまで」を把握する
4. 不明点があれば、実装に入る前に確認する

### decisions.md の追記ルール
- **append-only**（追記が基本、過去は書き換えない）
- 追記は「今日の日付のセクション」に入れる。無ければ作る
- 変更・撤回は「新しい決定として追記し、Supersedes参照」
- 見出しにはタグを付与（例：[CONFIG][DATA][DOCS][CODE][PROCESS][KAIZEN]）
- 変更したファイルは列挙（フルパス推奨）

---

## 要件定義書作成ガイド

### テンプレート
`C:\ProgramData\RK10\Tools\47出退勤確認_要件定義書テンプレート 20260115.xlsx`

### シート構成（10シート）
| No | シート名 | 内容 |
|----|----------|------|
| 1 | 1.概要 | プロジェクト概要、目的、背景 |
| 2 | 2.機能要件 | 機能ID・機能名・説明（A4縦1枚：14項目程度） |
| 3 | 3.非機能要件 | 要件ID・カテゴリ・説明（A4縦1枚：9項目程度） |
| 4 | 4.処理条件詳細 | 条件ID・条件名・判定ロジック |
| 5 | 5.データ仕様 | 設定ファイル・マスタファイルの仕様 |
| 6 | 6.外部IF・制約 | 外部システム接続仕様 |
| 7 | 7.設計思想 | アーキテクチャ、Pythonコマンド一覧 |
| 8 | 8.業務フロー | ステップ・処理内容・入出力ファイルパス |
| 9 | 9.PDD詳細手順 | 詳細処理ステップ（セレクタ、コマンド） |
| 10 | 客先確認事項 | 確認が必要な事項リスト |

### 作成時の注意点
1. テンプレートコピー後、全シートの内容を対象ロボット用に書き換える
2. シート2,3はA4縦1枚に収まるよう圧縮
3. **原本・出力ファイルのパスは必ずフルパスで記述**（LOCAL/PROD両方）
4. openpyxlでの編集時はシート名ではなくインデックスでアクセス（エンコーディング問題回避）

### 出力先
`C:\ProgramData\RK10\Robots\{ロボット番号}{ロボット名}\docs\{ロボット名}_要件定義書.xlsx`

---

## 問題発生時の対応プロセス（再発防止）

### 基本原則：二度と同じ問題を起こさない
1. **問題の深掘り（5 Whys）**
2. **再発防止策の策定（仕組みで防ぐ）**
3. **ドキュメント更新**
   - 恒常ルール → `Project Memory`
   - 決定/事実 → `plans/decisions.md`
4. **横展開（他シナリオ影響確認）**

---

## マスタデータ管理（SSOT）

### 正本マスタの定義
| データ種別 | 正本ファイル |
|-----------|-------------|
| 従業員情報 | `C:\ProgramData\RK10\Robots\47出退勤確認\config\employee_master.csv` |
| 勤務区分 | `C:\ProgramData\RK10\Robots\47出退勤確認\config\kbn_master.csv` |

### マスタ作成・更新時の検証プロセス
- 正本マスタとの照合を実施
- employee_idと名前の整合性を確認
- OCR由来のデータは必ず目視検証

### マスタ変更時の横展開チェックリスト
従業員情報を変更した場合、以下を確認・更新：
- `47出退勤確認\config\employee_master.csv`（正本）
- `37レコル公休・有休登録\config\employee_master.json`
- `42ドライブレポート抽出作業\config\利用者_YYYYMMDD.csv`

---

## 機能変更時の必須アクション（品質ゲート）

1. **コード修正**
2. **マスタ更新**（必要に応じて列追加・データ更新）
3. **要件定義書更新**（バージョンアップ、改訂履歴追記）
4. **関連マスタの横展開**（他シナリオへの影響確認と反映）
5. **検証（代表入力・照合・例外系）**（Exit Criteriaを満たす）

---

## 参照ドキュメント（必要時に参照）

- 44 技術詳細：`docs/44_OCR_technical.md`
- ツール選定：`docs/tool_selection_policy.md`

---

## Project Memory（append-only）

（「MDに書いて」で追記された恒常ルールはここに追加）

### 2026-01-17
- 正本をAGENTS.mdに移行し、CLAUDE.mdを入口化（@AGENTS.md）

### 2026-01-18
- **ブラウザ選択**: シナリオ作成でブラウザを使用する際は **Edge** を使用すること（Chrome禁止）

### 2026-01-19
- **OCR精度改善手順**（69.2% → 84.6%達成）:
  1. **診断ログ強化で原因特定** - vendor空時に `line_info`, `line_count`, `image_height` を出力し「OCR認識不足」vs「抽出ロジック不足」を切り分け
  2. **NG分析 → 対策決定** - raw_textに文字あり→パターン追加 / raw_text空→画像品質問題（DPI/ROI）
  3. **ファイル名抽出強化** - `vendor_keywords` にキーワード追加（名鉄協商、ゆうちょ銀行等）
  4. **カスケードOCR** - `lite_mode=True` → 欠損時のみ `lite_mode=False` で再処理
  - 詳細: `docs/KNOWLEDGE_OCR_PREPROCESSING.md`
